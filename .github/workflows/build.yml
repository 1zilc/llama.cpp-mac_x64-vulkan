name: Build llama.cpp with Vulkan on macOS x64

on:
  workflow_dispatch: # 允许手动触发
  schedule:
    - cron: "0 16 * * *" # UTC 时间每天 16:00，即北京时间凌晨 00:00

env:
  LLAMACPP_TAG: b7017

jobs:
  build-macos-vulkan:
    runs-on: macos-15-intel

    steps:
      - name: ccache
        uses: ggml-org/ccache-action@v1.2.16
        with:
          key: macOS-latest-cmake-x64
          evict-old-files: 1d

      - name: 安装依赖
        run: |
          brew install libomp vulkan-headers glslang molten-vk shaderc vulkan-tools

      - name: 验证 Vulkan 安装
        run: |
          vulkaninfo --summary || true

      - name: 获取最新的 llama.cpp 标签
        run: |
          # 获取最新的 tag
          LATEST_TAG=$(gh release -R "ggml-org/llama.cpp" list --limit 1 --json tagName -q ".[0].tagName")

          # 如果获取失败，使用默认值
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "无法获取最新标签,使用${{ env.LLAMACPP_TAG }}"
          fi

          echo "标签: $LATEST_TAG"
          echo "LLAMACPP_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "LLAMACPP_TAG=$LATEST_TAG" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - name: 检出 llama.cpp 代码
        uses: actions/checkout@v4
        with:
          repository: ggml-org/llama.cpp
          ref: ${{ env.LLAMACPP_TAG }}

      - name: 配置 CMake (Vulkan 支持)
        run: |
          cmake -B build \
            -DGGML_METAL=OFF \
            -DGGML_VULKAN=ON \
            -DVulkan_LIBRARY=$(brew --prefix molten-vk)/lib/libMoltenVK.dylib \
            -DVulkan_INCLUDE_DIR=$(brew --prefix molten-vk)/include \
            -DCMAKE_INSTALL_RPATH="@loader_path" \
            -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
            -DGGML_RPC=ON \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.3

      - name: 编译
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.logicalcpu)

      - name: 显示构建信息
        run: |
          ls -lh build/bin/ || true

      - name: 打包构建产物
        run: |
          # 复制必要的库文件
          cp $(brew --prefix molten-vk)/lib/libMoltenVK.dylib build/bin/ 2>/dev/null || true

          install_name_tool -change /usr/local/opt/molten-vk/lib/libMoltenVK.dylib \
          ./libMoltenVK.dylib build/bin/libggml-vulkan.dylib

          # 打包
          zip -r llama-${{ env.LLAMACPP_TAG }}-bin-macos-x64-vulkan.zip ./build/bin/*

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: llama-bin-macos-x64-vulkan.zip
          path: llama-${{ env.LLAMACPP_TAG }}-bin-macos-x64-vulkan.zip
          retention-days: 30

      - name: 创建 Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LLAMACPP_TAG }}
          name: ${{ env.LLAMACPP_TAG }}
          body: https://github.com/ggml-org/llama.cpp/releases/tag/${{ env.LLAMACPP_TAG }}
          files: llama-${{ env.LLAMACPP_TAG }}-bin-macos-x64-vulkan.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
