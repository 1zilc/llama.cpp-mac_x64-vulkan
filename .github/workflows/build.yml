name: Build llama.cpp with Vulkan on macOS x64

on:
  workflow_dispatch: # Allow manual trigger
  schedule:
    - cron: "0 4 * * *" # UTC 04:00 daily, which is 12:00 Beijing time

env:
  LLAMACPP_TAG: b7379
  MOLTEN_VK_TAG: v1.4.1

jobs:
  build-macos-vulkan:
    runs-on: macos-15-intel

    steps:
      - name: Install dependencies
        run: |
          brew install libomp vulkan-headers glslang molten-vk shaderc vulkan-tools

      - name: Download and extract specified MoltenVK
        run: |
          gh release download ${{ env.MOLTEN_VK_TAG }} --repo KhronosGroup/MoltenVK --pattern "MoltenVK-macos.tar"
          tar -xf MoltenVK-macos.tar
          mv MoltenVK/MoltenVK/dynamic/dylib/macOS/libMoltenVK.dylib $(brew --prefix molten-vk)/lib/libMoltenVK.dylib
          mv MoltenVK/MoltenVK/include $(brew --prefix molten-vk)/include
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify Vulkan installation
        run: |
          vulkaninfo --summary || true

      - name: Get latest llama.cpp tag
        run: |
          # Get the latest tag
          LATEST_TAG=$(gh release -R "ggml-org/llama.cpp" list --limit 1 --json tagName -q ".[0].tagName")

          # If fetching fails, use default
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Failed to fetch latest tag, using ${env.LLAMACPP_TAG}"
          fi

          echo "Tag: $LATEST_TAG"
          echo "LLAMACPP_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "LLAMACPP_TAG=$LATEST_TAG" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout llama.cpp source
        uses: actions/checkout@v4
        with:
          repository: ggml-org/llama.cpp
          ref: ${{ env.LLAMACPP_TAG }}

      - name: Configure CMake (Vulkan support)
        run: |
          cmake -B build \
            -DGGML_METAL=OFF \
            -DGGML_VULKAN=ON \
            -DLLAMA_CURL=1 \
            -DVulkan_LIBRARY=$(brew --prefix molten-vk)/lib/libMoltenVK.dylib \
            -DVulkan_INCLUDE_DIR=$(brew --prefix molten-vk)/include \
            -DCMAKE_INSTALL_RPATH="@loader_path" \
            -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
            -DGGML_RPC=ON \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.3

      - name: Build
        run: |
          cmake --build build --config Release -j$(sysctl -n hw.logicalcpu)

      - name: Show build information
        run: |
          ls -lh build/bin/ || true

      - name: Package build artifacts
        run: |
          # Copy required library files
          cp $(brew --prefix molten-vk)/lib/libMoltenVK.dylib build/bin/ 2>/dev/null || true

          install_name_tool -change /usr/local/opt/molten-vk/lib/libMoltenVK.dylib \
          ./libMoltenVK.dylib build/bin/libggml-vulkan.dylib

          # Create zip archive
          zip -r llama-${{ env.LLAMACPP_TAG }}-bin-macos-x64-vulkan.zip ./build/bin/*

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: llama-bin-macos-x64-vulkan
          path: llama-${{ env.LLAMACPP_TAG }}-bin-macos-x64-vulkan.zip
          retention-days: 30

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.LLAMACPP_TAG }}
          name: ${{ env.LLAMACPP_TAG }}
          body: https://github.com/ggml-org/llama.cpp/releases/tag/${{ env.LLAMACPP_TAG }} with molten-vk ${{ env.MOLTEN_VK_TAG }}
          files: llama-${{ env.LLAMACPP_TAG }}-bin-macos-x64-vulkan.zip
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
